---
- name: Network Analytics and Reporting
  hosts: localhost
  become: yes  # Use sudo for permissions (e.g., to install packages)

  tasks:
    - name: Install required packages (iputils for ping)
      ansible.builtin.package:
        name: iputils
        state: present
      when: ansible_facts['pkg_mgr'] == 'dnf'  # For Fedora/CentOS/RHEL

    - name: Measure latency
      shell: >
        /usr/bin/ping -c 4 google.com |  # Use absolute path
        grep 'rtt' |
        awk -F'= ' '{print $2}' |
        awk -F'/' '{print $2}' |
        awk '{printf "%.2f", $1}'
      register: latency
      changed_when: false
      args:
        executable: /bin/bash

    - name: Debug latency output
      debug:
        var: latency.stdout

    - name: Measure download speed
      shell: >
        curl -s https://raw.githubusercontent.com/sivel/speedtest-cli/master/speedtest.py |
        python3 - --secure |
        grep 'Download' |
        awk '{print $2}'
      register: download_speed
      ignore_errors: yes

    - name: Measure uptime
      shell: "awk '{print $1}' /proc/uptime"
      register: uptime

    - name: Generate report
      copy:
        dest: /tmp/network_report.txt
        content: |
          📊 Network Performance Report
          ───────────────────────────────
          🔁 Latency       │ {{ latency.stdout | default('N/A') }} ms
          📥 Download Speed │ {{ download_speed.stdout | default('N/A') }} Mbps
          ⏱️ Uptime        │ {{ uptime.stdout | float | default(0) / 3600 | round(2) }} hours
          ───────────────────────────────

    - name: Verify report file exists
      stat:
        path: /tmp/network_report.txt
      register: report_file

    - name: Fail if report missing
      fail:
        msg: "Report file not found at /tmp/network_report.txt"
      when: not report_file.stat.exists

    - name: Send email with report
      community.general.mail:
        host: smtp.gmail.com
        port: 587
        username: "equipmentold@gmail.com"
        password: "inpb nclm tcvo tudq"  # Use App Password if 2FA is enabled
        to:
          - "gjb1088@gmail.com"
        subject: "Daily Network Analytics Report"
        body: |
          Attached is the latest network performance report.
          
          📊 Key Metrics:
          - Latency: {{ latency.stdout | default('N/A') }} ms
          - Download Speed: {{ download_speed.stdout | default('N/A') }} Mbps
          - Uptime: {{ uptime.stdout | float | default(0) / 3600 | round(2) }} hours
        attach:
          - /tmp/network_report.txt
        secure: starttls
        timeout: 30
